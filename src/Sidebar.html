<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
      direction: rtl;
      background: #f8f9fa;
      color: #333;
      font-size: 13px;
      line-height: 1.5;
      padding: 16px;
    }

    h1 {
      font-size: 18px;
      color: #1a73e8;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .subtitle {
      color: #666;
      font-size: 12px;
      margin-bottom: 16px;
    }

    .btn-primary {
      display: block;
      width: 100%;
      padding: 12px 16px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #1557b0;
    }

    .btn-primary:disabled {
      background: #94b8e8;
      cursor: not-allowed;
    }

    .progress-container {
      display: none;
      margin: 16px 0;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #1a73e8;
      border-radius: 3px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .progress-text {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
      text-align: center;
    }

    .results-container {
      display: none;
      margin-top: 16px;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .section-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 500;
    }

    .status-pass {
      background: #e6f4ea;
      color: #137333;
    }

    .status-warn {
      background: #fef7e0;
      color: #b06000;
    }

    .status-fail {
      background: #fce8e6;
      color: #c5221f;
    }

    .status-info {
      background: #e8f0fe;
      color: #1a73e8;
    }

    .section-body {
      margin-top: 10px;
      display: none;
    }

    .section.expanded .section-body {
      display: block;
    }

    .section-toggle {
      font-size: 12px;
      color: #999;
      transition: transform 0.2s;
    }

    .section.expanded .section-toggle {
      transform: rotate(90deg);
    }

    .item {
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 12px;
    }

    .item:last-child {
      border-bottom: none;
    }

    .item-finding {
      color: #137333;
    }

    .item-missing, .item-error {
      color: #c5221f;
    }

    .item-warning {
      color: #b06000;
    }

    .comment-card {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 10px 12px;
      margin: 8px 0;
      border-right: 3px solid #ddd;
    }

    .comment-card.praise {
      border-right-color: #137333;
      background: #f1f8f1;
    }

    .comment-card.criticism {
      border-right-color: #c5221f;
      background: #fef6f5;
    }

    .comment-card.suggestion {
      border-right-color: #1a73e8;
      background: #f0f5fe;
    }

    .comment-type {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .comment-type.praise { color: #137333; }
    .comment-type.criticism { color: #c5221f; }
    .comment-type.suggestion { color: #1a73e8; }

    .comment-text {
      font-size: 12px;
      line-height: 1.6;
    }

    .methodology-section {
      background: #fffde7;
      border: 1px solid #fff9c4;
    }

    .methodology-assessment {
      background: #fff9c4;
      padding: 10px 12px;
      border-radius: 6px;
      margin: 8px 0;
      font-size: 12px;
      line-height: 1.6;
    }

    .methodology-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    .meta-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #f0f0f0;
    }

    .summary-section {
      border: 2px solid #1a73e8;
    }

    .summary-approved {
      background: #e6f4ea;
      border-color: #137333;
    }

    .summary-not-approved {
      background: #fce8e6;
      border-color: #c5221f;
    }

    .summary-text {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.6;
      padding: 8px 0;
    }

    .summary-issues {
      margin-top: 8px;
    }

    .summary-issue {
      font-size: 12px;
      padding: 3px 0;
      color: #666;
    }

    .error-container {
      display: none;
      background: #fce8e6;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      color: #c5221f;
    }

    .no-api-notice {
      background: #fff3e0;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 12px;
      color: #e65100;
    }

    .priority-high { font-weight: 600; }
    .priority-medium { font-weight: 400; }
    .priority-low { font-weight: 300; color: #666; }

    .expand-list {
      margin: 6px 0;
      padding-right: 20px;
    }

    .expand-list li {
      font-size: 12px;
      padding: 2px 0;
    }
  </style>
</head>
<body>

  <h1>בודק עבודות אקדמיות</h1>
  <p class="subtitle">בדיקת מבנה, APA7, ותוכן הצעת מחקר</p>

  <button class="btn-primary" id="runBtn" onclick="runCheck()">
    הפעל בדיקה מלאה
  </button>

  <div class="progress-container" id="progressContainer">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <p class="progress-text" id="progressText">מתחיל בדיקה...</p>
  </div>

  <div class="error-container" id="errorContainer"></div>

  <div class="results-container" id="resultsContainer"></div>

  <script>
    function runCheck() {
      var btn = document.getElementById('runBtn');
      var progress = document.getElementById('progressContainer');
      var results = document.getElementById('resultsContainer');
      var errorContainer = document.getElementById('errorContainer');

      btn.disabled = true;
      btn.textContent = 'בודק...';
      progress.style.display = 'block';
      results.style.display = 'none';
      results.innerHTML = '';
      errorContainer.style.display = 'none';

      animateProgress();

      google.script.run
        .withSuccessHandler(function(data) {
          setProgress(100, 'הבדיקה הושלמה!');
          setTimeout(function() {
            progress.style.display = 'none';
            displayResults(data);
            btn.disabled = false;
            btn.textContent = 'הפעל בדיקה מחדש';
          }, 500);
        })
        .withFailureHandler(function(error) {
          progress.style.display = 'none';
          errorContainer.style.display = 'block';
          errorContainer.textContent = 'שגיאה: ' + error.message;
          btn.disabled = false;
          btn.textContent = 'הפעל בדיקה מלאה';
        })
        .runFullCheck();
    }

    var progressInterval;
    function animateProgress() {
      var steps = [
        { pct: 15, text: 'בודק דף שער...' },
        { pct: 30, text: 'בודק מבנה פרקים...' },
        { pct: 45, text: 'בודק ביבליוגרפיה APA7...' },
        { pct: 65, text: 'סוקר תוכן עם AI...' },
        { pct: 80, text: 'בודק פרק שיטה לעומק...' },
        { pct: 90, text: 'מכין סיכום...' }
      ];
      var i = 0;
      clearInterval(progressInterval);
      progressInterval = setInterval(function() {
        if (i < steps.length) {
          setProgress(steps[i].pct, steps[i].text);
          i++;
        } else {
          clearInterval(progressInterval);
        }
      }, 2000);
    }

    function setProgress(pct, text) {
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressText').textContent = text;
    }

    function displayResults(data) {
      clearInterval(progressInterval);
      var container = document.getElementById('resultsContainer');
      container.style.display = 'block';

      if (data.error) {
        container.innerHTML = '<div class="section"><div class="section-title">' + data.message + '</div></div>';
        return;
      }

      var html = '';

      // 1. דף שער
      html += buildCoverPageSection(data.coverPage);

      // 2. מבנה פרקים
      html += buildChaptersSection(data.chapters);

      // 3. ביבליוגרפיה APA7
      html += buildAPASection(data.apa);

      // 4. סקירת תוכן
      if (data.contentReview) {
        if (data.contentReview.available === false) {
          html += '<div class="no-api-notice">' + data.contentReview.message + '</div>';
        } else {
          // הערות לכל פרק
          if (data.contentReview.chapters) {
            for (var i = 0; i < data.contentReview.chapters.length; i++) {
              html += buildChapterReviewSection(data.contentReview.chapters[i]);
            }
          }

          // 6. פרק שיטה מעמיק
          if (data.contentReview.methodology) {
            html += buildMethodologySection(data.contentReview.methodology);
          }
        }
      }

      // 7. סיכום סופי
      html += buildSummarySection(data.summary);

      container.innerHTML = html;

      // הוספת אירועי לחיצה לכל הסקשנים
      var sections = container.querySelectorAll('.section-header');
      for (var j = 0; j < sections.length; j++) {
        sections[j].addEventListener('click', function() {
          this.parentElement.classList.toggle('expanded');
        });
      }

      // פתיחת הסיכום ופרק השיטה אוטומטית
      var autoExpand = container.querySelectorAll('.auto-expand');
      for (var k = 0; k < autoExpand.length; k++) {
        autoExpand[k].classList.add('expanded');
      }
    }

    // ===================== בונים סקשנים =====================

    function buildCoverPageSection(data) {
      var status = data.valid ? 'pass' : 'fail';
      var statusText = data.valid ? 'תקין' : 'חסרים פרטים';

      var body = '';
      if (data.findings) {
        for (var i = 0; i < data.findings.length; i++) {
          body += '<div class="item item-finding">&#10003; ' + data.findings[i] + '</div>';
        }
      }
      if (data.missing) {
        for (var j = 0; j < data.missing.length; j++) {
          body += '<div class="item item-missing">&#10007; ' + data.missing[j] + '</div>';
        }
      }

      return buildSection('דף שער', statusText, status, body);
    }

    function buildChaptersSection(data) {
      var status = data.valid ? 'pass' : 'fail';
      var statusText = data.valid ? 'תקין' : 'נמצאו חוסרים';

      var body = '';
      if (data.findings) {
        for (var i = 0; i < data.findings.length; i++) {
          body += '<div class="item item-finding">&#10003; ' + data.findings[i] + '</div>';
        }
      }
      if (data.missing) {
        for (var j = 0; j < data.missing.length; j++) {
          body += '<div class="item item-missing">&#10007; ' + data.missing[j] + '</div>';
        }
      }

      return buildSection('מבנה פרקים', statusText, status, body);
    }

    function buildAPASection(data) {
      if (!data.found) {
        return buildSection('ביבליוגרפיה APA7', 'לא נמצא', 'fail',
          '<div class="item item-error">' + (data.errors && data.errors[0] ? data.errors[0] : 'לא נמצא קטע ביבליוגרפיה') + '</div>');
      }

      var errorCount = data.errors ? data.errors.length : 0;
      var warnCount = data.warnings ? data.warnings.length : 0;
      var status = errorCount > 3 ? 'fail' : (errorCount > 0 || warnCount > 3) ? 'warn' : 'pass';
      var statusText = errorCount === 0 && warnCount === 0 ? 'תקין' :
                       errorCount + ' שגיאות, ' + warnCount + ' אזהרות';

      var body = '';

      if (data.findings) {
        for (var i = 0; i < data.findings.length; i++) {
          body += '<div class="item item-finding">&#10003; ' + data.findings[i] + '</div>';
        }
      }

      if (data.errors) {
        for (var j = 0; j < data.errors.length; j++) {
          body += '<div class="item item-error">&#10007; ' + data.errors[j] + '</div>';
        }
      }

      if (data.warnings) {
        for (var k = 0; k < data.warnings.length; k++) {
          body += '<div class="item item-warning">&#9888; ' + data.warnings[k] + '</div>';
        }
      }

      return buildSection('ביבליוגרפיה APA7', statusText, status, body);
    }

    function buildChapterReviewSection(chapterData) {
      var body = '';

      if (chapterData.writingQuality) {
        var qualityMap = {
          'good': 'טובה',
          'fair': 'סבירה',
          'needs_improvement': 'דורשת שיפור'
        };
        var levelMap = {
          'appropriate': 'מתאימה',
          'needs_work': 'דורשת עבודה',
          'insufficient': 'לא מספקת'
        };
        body += '<div class="methodology-meta">';
        if (chapterData.writingQuality) {
          body += '<span class="meta-tag">כתיבה: ' + (qualityMap[chapterData.writingQuality] || chapterData.writingQuality) + '</span>';
        }
        if (chapterData.academicLevel) {
          body += '<span class="meta-tag">רמה אקדמית: ' + (levelMap[chapterData.academicLevel] || chapterData.academicLevel) + '</span>';
        }
        body += '</div>';
      }

      if (chapterData.comments) {
        for (var i = 0; i < chapterData.comments.length; i++) {
          var c = chapterData.comments[i];
          var typeLabel = c.type === 'praise' ? 'חיזוק' :
                         c.type === 'criticism' ? 'ביקורת' :
                         c.type === 'suggestion' ? 'הצעה' : 'הערה';
          body += '<div class="comment-card ' + (c.type || 'suggestion') + '">';
          body += '<div class="comment-type ' + (c.type || '') + '">' + typeLabel + '</div>';
          body += '<div class="comment-text">' + c.text + '</div>';
          body += '</div>';
        }
      }

      return buildSection('הערות: ' + chapterData.title, '', 'info', body);
    }

    function buildMethodologySection(data) {
      var body = '';

      if (data.overallAssessment) {
        body += '<div class="methodology-assessment">' + data.overallAssessment + '</div>';
      }

      if (data.clarity || data.completeness) {
        var clarityMap = {
          'clear': 'ברור',
          'mostly_clear': 'ברור ברובו',
          'unclear': 'לא ברור'
        };
        var compMap = {
          'complete': 'שלם',
          'mostly_complete': 'שלם ברובו',
          'needs_expansion': 'דורש הרחבה',
          'missing_elements': 'חסרים רכיבים'
        };
        body += '<div class="methodology-meta">';
        if (data.clarity) {
          body += '<span class="meta-tag">בהירות: ' + (clarityMap[data.clarity] || data.clarity) + '</span>';
        }
        if (data.completeness) {
          body += '<span class="meta-tag">שלמות: ' + (compMap[data.completeness] || data.completeness) + '</span>';
        }
        body += '</div>';
      }

      if (data.comments) {
        for (var i = 0; i < data.comments.length; i++) {
          var c = data.comments[i];
          var typeLabel = c.type === 'praise' ? 'חיזוק' :
                         c.type === 'criticism' ? 'ביקורת' :
                         c.type === 'suggestion' ? 'הצעה' : 'הערה';
          var priorityClass = c.priority ? 'priority-' + c.priority : '';
          body += '<div class="comment-card ' + (c.type || 'suggestion') + '">';
          body += '<div class="comment-type ' + (c.type || '') + '">' + typeLabel;
          if (c.category) body += ' - ' + c.category;
          body += '</div>';
          body += '<div class="comment-text ' + priorityClass + '">' + c.text + '</div>';
          body += '</div>';
        }
      }

      if (data.needsExpansion && data.needsExpansion.length > 0) {
        body += '<div style="margin-top:10px;font-weight:600;font-size:12px;">סעיפים שדורשים הרחבה:</div>';
        body += '<ul class="expand-list">';
        for (var j = 0; j < data.needsExpansion.length; j++) {
          body += '<li>' + data.needsExpansion[j] + '</li>';
        }
        body += '</ul>';
      }

      if (data.canBeRemoved && data.canBeRemoved.length > 0) {
        body += '<div style="margin-top:10px;font-weight:600;font-size:12px;">סעיפים שניתן לקצר/להשמיט:</div>';
        body += '<ul class="expand-list">';
        for (var k = 0; k < data.canBeRemoved.length; k++) {
          body += '<li>' + data.canBeRemoved[k] + '</li>';
        }
        body += '</ul>';
      }

      return '<div class="section methodology-section auto-expand">' +
        '<div class="section-header">' +
        '<div><span class="section-title">בדיקת פרק השיטה (מעמיק)</span></div>' +
        '<span class="section-toggle">&#9654;</span>' +
        '</div>' +
        '<div class="section-body">' + body + '</div>' +
        '</div>';
    }

    function buildSummarySection(data) {
      if (!data) return '';

      var cssClass = data.approved ? 'summary-approved' : 'summary-not-approved';
      var body = '<div class="summary-text">' + data.text + '</div>';

      if (data.issues && data.issues.length > 0) {
        body += '<div class="summary-issues">';
        for (var i = 0; i < data.issues.length; i++) {
          body += '<div class="summary-issue">- ' + data.issues[i] + '</div>';
        }
        body += '</div>';
      }

      return '<div class="section summary-section ' + cssClass + ' auto-expand">' +
        '<div class="section-header">' +
        '<span class="section-title">סיכום והחלטה</span>' +
        '<span class="section-toggle">&#9654;</span>' +
        '</div>' +
        '<div class="section-body">' + body + '</div>' +
        '</div>';
    }

    // ===================== עזר =====================

    function buildSection(title, statusText, statusType, bodyHtml) {
      return '<div class="section">' +
        '<div class="section-header">' +
        '<span class="section-title">' + title + '</span>' +
        '<div>' +
        (statusText ? '<span class="section-status status-' + statusType + '">' + statusText + '</span> ' : '') +
        '<span class="section-toggle">&#9654;</span>' +
        '</div>' +
        '</div>' +
        '<div class="section-body">' + bodyHtml + '</div>' +
        '</div>';
    }
  </script>

</body>
</html>
